import pandas as pd
import numpy as np
import os
from datetime import datetime
import warnings

warnings.filterwarnings('ignore', category=FutureWarning)
#
# --- é…ç½®å‚æ•° ---
BASE_DATA_PATH = r"C:\Users\cufet\Desktop\æµ‹è¯•é›†"
# æ•°æ®æºæ–‡ä»¶
DATA_FILE = "ä¸­è¯500æˆåˆ†è‚¡æ•°æ®-å¿«ç…§2.xlsx"
# æ•°æ®æºä¸­çš„ Sheet åç§°
MKT_CAP_SHEET = 'è‡ªç”±æµé€šå¸‚å€¼'
STATUS_SHEET = 'æˆåˆ†è‚¡çŠ¶æ€çŸ©é˜µ'
BL_WEIGHTS_FILE = 'ä¼˜åŒ–æƒé‡ç»“æœ.xlsx'

# --- 1. å®šä¹‰æ–‡ä»¶å®Œæ•´è·¯å¾„ ---
data_path = os.path.join(BASE_DATA_PATH, DATA_FILE)
bl_weights_path = os.path.join(BASE_DATA_PATH, BL_WEIGHTS_FILE)
#
# print("--- ğŸš€ å¼€å§‹ç›´æ¥åŠ è½½æ ¸å¿ƒæ•°æ® ğŸš€ ---")
# print("-" * 40)
#
# # =================================================================
# # === ä»»åŠ¡ A: åŠ è½½ BL ä¼˜åŒ–æƒé‡ (ç”¨äºè·å–è°ƒä»“æ—¥æœŸ) ===
# # =================================================================
# print(f"1. å°è¯•åŠ è½½ BL ä¼˜åŒ–æƒé‡: {BL_WEIGHTS_FILE}")
# try:
#     # å‡è®¾ï¼šBL æƒé‡æ–‡ä»¶ç¬¬ä¸€è¡Œæ˜¯æ—¥æœŸï¼Œç¬¬ä¸€åˆ—æ˜¯ä»£ç ã€‚æˆ‘ä»¬ä½¿ç”¨ header=None æ¥é¿å…ç»“æ„å‡è®¾ã€‚
#     bl_weights_raw = pd.read_excel(bl_weights_path, sheet_name=0, header=None)
#
#     # æå–æ—¥æœŸ (ç¬¬ä¸€è¡Œï¼Œä»ç¬¬äºŒåˆ—å¼€å§‹)
#     bl_rebalance_dates_raw = bl_weights_raw.iloc[0, 1:].tolist()
#     bl_rebalance_dates = pd.to_datetime(bl_rebalance_dates_raw, errors='coerce').dropna().normalize()
#
#     # å°†ç¬¬ä¸€è¡Œä½œä¸ºåˆ—åï¼Œç¬¬ä¸€åˆ—ä½œä¸ºç´¢å¼•ï¼Œåˆ›å»ºæœ€ç»ˆçš„ BL æƒé‡ DataFrame
#     bl_weights_df = bl_weights_raw.iloc[1:].set_index(0)
#     bl_weights_df.columns = bl_rebalance_dates.tolist()
#     bl_weights_df.index = bl_weights_df.index.astype(str).str.strip()
#
#     # æ¸…ç†å’Œæ•°å€¼åŒ–
#     bl_weights_df = bl_weights_df.apply(pd.to_numeric, errors='coerce').fillna(0)
#
#     print(f"âœ… BL æƒé‡æ•°æ®åŠ è½½æˆåŠŸã€‚å½¢çŠ¶: {bl_weights_df.shape}")
#     print("--- BL æƒé‡ (å‰ 5 è¡Œ, ä»…æ—¥æœŸåˆ—): ---")
#     print(bl_weights_df.head(5).iloc[:, :3])
#     print("-" * 40)
#
# except Exception as e:
#     print(f"âŒ è‡´å‘½é”™è¯¯ï¼šåŠ è½½ BL æƒé‡æ–‡ä»¶å¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œç»“æ„ã€‚è¯¦ç»†ä¿¡æ¯: {e}")
#     bl_weights_df = pd.DataFrame()
#
# # =================================================================
# # === ä»»åŠ¡ B: åŠ è½½ æˆåˆ†è‚¡çŠ¶æ€çŸ©é˜µ (STATUS_SHEET) - æœ€ç»ˆä¿®æ­£ç‰ˆ v3 (æ‰‹åŠ¨è®¾ç½® Header) ===
# # =================================================================
# print(f"2. å°è¯•åŠ è½½ æˆåˆ†è‚¡çŠ¶æ€çŸ©é˜µ: {STATUS_SHEET}")
# try:
#     # 1. åŸå§‹è¯»å–ï¼šä¸è®¾ headerï¼Œè¯»å–æ‰€æœ‰æ•°æ®
#     status_raw = pd.read_excel(data_path, sheet_name=STATUS_SHEET, header=None)
#
#     # 2. æå–åˆ—å (Header)ï¼šæ¥è‡ª Excel ç¬¬ 2 è¡Œ (ç´¢å¼• 1)
#     # ğŸš¨ ä¿®æ­£æ ¸å¿ƒï¼šå¼ºåˆ¶ä½¿ç”¨ç´¢å¼• 1 ä½œä¸ºåˆ—å
#     header_row = status_raw.iloc[0, :].astype(str).tolist()
#
#     # 3. æå–æ•°æ®ä½“ï¼šä» Excel ç¬¬ 3 è¡Œ (ç´¢å¼• 2) å¼€å§‹
#     status_matrix_df = status_raw.iloc[1:].copy()
#     status_matrix_df.columns = header_row  # è®¾ç½®åˆ—å
#
#     # 4. æ¸…ç†åˆ—åï¼Œå¹¶è®¾ç½®ç´¢å¼•
#     clean_cols_map = {}
#     for col in status_matrix_df.columns:
#         # æ¸…ç†åˆ—åï¼Œç§»é™¤ç©ºæ ¼ã€æ¢è¡Œç¬¦å’Œæ½œåœ¨çš„ 'nan' å­—ç¬¦ä¸²
#         cleaned_col = str(col).strip().replace(' ', '').replace('\n', '').replace('nan', '')
#         clean_cols_map[col] = cleaned_col
#
#     status_matrix_df.columns = clean_cols_map.values()
#
#     # 5. è®¾ç½®ç´¢å¼•ï¼ˆè‚¡ç¥¨ä»£ç ï¼‰ï¼Œå‡è®¾åœ¨æ¸…ç†åçš„ç¬¬ä¸€åˆ—
#     index_col_name = status_matrix_df.columns[0]
#     status_matrix_df = status_matrix_df.set_index(index_col_name)
#     status_matrix_df.index = status_matrix_df.index.astype(str).str.strip()
#
#     # 6. è§„èŒƒåŒ–åˆ—å (æ—¥æœŸ) - é‡‡ç”¨æœˆæœ«åŸåˆ™
#     date_cols_map = {}
#     from pandas.tseries.offsets import MonthEnd
#
#     PREFIX = 'æ˜¯å¦æˆåˆ†è‚¡_'  # æ˜ç¡®åŒ¹é…å‰ç¼€
#
#     for col in status_matrix_df.columns:
#         if isinstance(col, str) and col.startswith(PREFIX):
#             date_str = col.replace(PREFIX, '')
#             dt = pd.to_datetime(date_str, format='%Y-%m', errors='coerce').normalize() + MonthEnd(0)
#             date_cols_map[col] = dt
#
#     # 7. ä»…ä¿ç•™æ—¥æœŸåˆ—å¹¶é‡å‘½å
#     date_cols = list(date_cols_map.keys())
#     if not date_cols:
#         print(f"DEBUG: æœ€ç»ˆæ¸…ç†åçš„åˆ—ååˆ—è¡¨ï¼š{status_matrix_df.columns.tolist()}")
#         raise ValueError("æœªæ‰¾åˆ°ä»»ä½•èƒ½åŒ¹é… 'æ˜¯å¦æˆåˆ†è‚¡_YYYY-MM' æ ¼å¼çš„åˆ—ã€‚")
#
#     status_matrix_df = status_matrix_df[date_cols]
#     status_matrix_df.columns = date_cols_map.values()
#
#     # 8. è½¬æ¢ä¸ºæ•°å€¼ (0/1)
#     status_matrix_df = status_matrix_df.apply(pd.to_numeric, errors='coerce').fillna(0).astype(int)
#
#     print(f"âœ… çŠ¶æ€çŸ©é˜µåŠ è½½æˆåŠŸã€‚å½¢çŠ¶: {status_matrix_df.shape}")
#     print("--- çŠ¶æ€çŸ©é˜µ (å‰ 5 è¡Œ): ---")
#     print(status_matrix_df.head(5).iloc[:, :3])
#     print("-" * 40)
#
# except Exception as e:
#     print(f"âŒ è‡´å‘½é”™è¯¯ï¼šåŠ è½½çŠ¶æ€çŸ©é˜µå¤±è´¥ã€‚è¯·æ£€æŸ¥ Sheet åç§°å’Œç»“æ„ã€‚è¯¦ç»†ä¿¡æ¯: {e}")
#     status_matrix_df = pd.DataFrame()
#
# # =================================================================
# # === ä»»åŠ¡ C: åŠ è½½ è‡ªç”±æµé€šå¸‚å€¼ (MKT_CAP_SHEET) - æœ€ç»ˆç¨³å®šç‰ˆ v5 (ä¿®æ­£ strftime é”™è¯¯) ===
# # =================================================================
# print(f"3. å°è¯•åŠ è½½è‡ªç”±æµé€šå¸‚å€¼: {MKT_CAP_SHEET}")
# try:
#     # 1. åŸå§‹è¯»å–ï¼šä¸è®¾ header
#     mkt_cap_raw = pd.read_excel(data_path, sheet_name=MKT_CAP_SHEET, header=None)
#
#     # 2. æå–è‚¡ç¥¨ä»£ç  (è¡Œç´¢å¼•)ï¼šPandas ç´¢å¼• 2 (Excel ç¬¬ 3 è¡Œ)ï¼Œä» Col 1 å¼€å§‹
#     stock_codes_series = mkt_cap_raw.iloc[2, 1:]
#
#     # 3. æå–æ—¥æœŸ (åˆ—å)ï¼šPandas ç´¢å¼• 3 (Excel ç¬¬ 4 è¡Œ) å¼€å§‹ï¼ŒCol 0
#     date_series = mkt_cap_raw.iloc[3:, 0]
#
#     # 4. æå–å¸‚å€¼æ•°æ® (NumPy æ•°ç»„)ï¼šPandas ç´¢å¼• 3 (Excel ç¬¬ 4 è¡Œ) å¼€å§‹ï¼Œä» Col 1 å¼€å§‹
#     market_cap_values = mkt_cap_raw.iloc[3:, 1:].values
#
#     # --- B. æ¸…ç†å’ŒéªŒè¯ ---
#
#     # 5. æ¸…ç†è‚¡ç¥¨ä»£ç  (è¿‡æ»¤ NaN/ç©ºå€¼)
#     valid_cols_mask = stock_codes_series.notna() & (stock_codes_series != '')
#     valid_stock_codes = stock_codes_series[valid_cols_mask].astype(str).str.strip().tolist()
#
#     # 6. æ¸…ç†æ—¥æœŸ (è½¬æ¢ä¸º YYYY-MM-DD å­—ç¬¦ä¸²)
#     valid_dates = pd.to_datetime(date_series, errors='coerce').dropna().dt.normalize()
#     # ğŸš¨ ä¿®æ­£æ ¸å¿ƒï¼šä½¿ç”¨ .dt.strftime()
#     valid_date_strings = valid_dates.dt.strftime('%Y-%m-%d').tolist()
#
#     # 7. è¿‡æ»¤å¸‚å€¼æ•°æ®æ•°ç»„ï¼Œåªä¿ç•™æœ‰æ•ˆè‚¡ç¥¨ä»£ç å¯¹åº”çš„åˆ—
#     valid_market_cap_values = market_cap_values[:, valid_cols_mask.values]
#
#     # --- C. é‡æ„ DataFrame ---
#
#     # 8. åˆ›å»ºæœ€ç»ˆ DataFrame
#     mkt_cap_final = pd.DataFrame(
#         data=valid_market_cap_values.T,
#         index=valid_stock_codes,
#         columns=valid_date_strings
#     )
#
#     # 9. æ•°å€¼åŒ–
#     mkt_cap_final = mkt_cap_final.apply(lambda x: pd.to_numeric(x, errors='coerce')).fillna(0)
#     mkt_cap_final = mkt_cap_final.dropna(how='all', axis=0)
#
#     print(f"âœ… è‡ªç”±æµé€šå¸‚å€¼åŠ è½½æˆåŠŸã€‚å½¢çŠ¶: {mkt_cap_final.shape}")
#     print("--- è‡ªç”±æµé€šå¸‚å€¼ (å‰ 5 è¡Œ, ä»…æ—¥æœŸåˆ—): ---")
#     print(mkt_cap_final.head(5).iloc[:, :3])
#     print("-" * 40)
#
# except Exception as e:
#     print(f"âŒ è‡´å‘½é”™è¯¯ï¼šåŠ è½½è‡ªç”±æµé€šå¸‚å€¼å¤±è´¥ã€‚è¯·æ£€æŸ¥ Sheet åç§°ã€ç»“æ„å’Œç´¢å¼•ã€‚è¯¦ç»†ä¿¡æ¯: {e}")
#     mkt_cap_final = pd.DataFrame()
#
# BASE_DATA_PATH = r"C:\Users\cufet\Desktop\æµ‹è¯•é›†"
# BL_WEIGHTS_FILE = 'ä¼˜åŒ–æƒé‡ç»“æœ.xlsx'
# bl_weights_path = os.path.join(BASE_DATA_PATH, BL_WEIGHTS_FILE)
#
# print("--- ğŸš€ å¼€å§‹åŠ è½½ BL ä¼˜åŒ–æƒé‡ ğŸš€ ---")
# print("-" * 40)
#
#
# # =================================================================
# # === ä»»åŠ¡ A: åªè¯»å–è°ƒä»“æ—¥ (ç¬¬ä¸€è¡Œï¼Œä» B åˆ—å¼€å§‹) - ä¿®æ­£ç‰ˆ ===
# # =================================================================
# bl_rebalance_dates = []
#
# try:
#     # 1. åŸå§‹è¯»å–ï¼šä¸è®¾ headerï¼Œå‡è®¾ç¬¬ä¸€è¡Œæ˜¯æ—¥æœŸ
#     bl_weights_raw = pd.read_excel(bl_weights_path, sheet_name=0, header=None)
#
#     # 2. æå–æ—¥æœŸ (Excel ç¬¬ 1 è¡Œï¼Œä» B åˆ—å¼€å§‹ï¼Œå³ iloc[0, 1:])
#     bl_rebalance_dates_raw = bl_weights_raw.iloc[0, 1:]
#
#     # 3. è§„èŒƒåŒ–ä¸ºæ—¥æœŸå¯¹è±¡ï¼Œç§»é™¤æ— æ•ˆå€¼ï¼Œå¹¶è½¬æ¢ä¸º YYYY-MM-DD å­—ç¬¦ä¸²åˆ—è¡¨
#
#     # ğŸš¨ ä¿®æ­£æ ¸å¿ƒï¼šä½¿ç”¨ .dt.normalize() å’Œ .dt.strftime()
#     dates_series = pd.to_datetime(bl_rebalance_dates_raw, errors='coerce').dropna()
#     dates_series = dates_series.dt.normalize()
#
#     # 4. è½¬æ¢ä¸ºå­—ç¬¦ä¸²åˆ—è¡¨
#     bl_rebalance_dates = dates_series.dt.strftime('%Y-%m-%d').tolist()
#
#     if bl_rebalance_dates:
#         print(f"âœ… BL è°ƒä»“æ—¥åŠ è½½æˆåŠŸã€‚å…±å‘ç° {len(bl_rebalance_dates)} ä¸ªè°ƒä»“æ—¥ã€‚")
#         print("--- å‰ 5 ä¸ªè°ƒä»“æ—¥: ---")
#         print(bl_rebalance_dates[:5])
#     else:
#         print("âŒ è­¦å‘Šï¼šè°ƒä»“æ—¥åˆ—è¡¨ä¸ºç©ºã€‚è¯·æ£€æŸ¥ Excel æ–‡ä»¶ç¬¬ä¸€è¡Œ B åˆ—åŠä¹‹åçš„æ—¥æœŸæ ¼å¼ã€‚")
#
#     print("-" * 40)
#
# except Exception as e:
#     print(f"âŒ è‡´å‘½é”™è¯¯ï¼šåªè¯»å–è°ƒä»“æ—¥å¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œç»“æ„ã€‚è¯¦ç»†ä¿¡æ¯: {e}")
#     bl_rebalance_dates = []
#
# # =================================================================
# # === æ–°å¢é€»è¾‘ï¼šç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°è°ƒä»“æ—¥æœŸå¯¹åº”çš„å½“æ—¥è‡ªç”±æµé€šå¸‚å€¼ ===
# # =================================================================
# print("\n--- ğŸš€ æ–°å¢é€»è¾‘ï¼šç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°è°ƒä»“æ—¥å¸‚å€¼ ğŸš€ ---")
#
# # ç¡®ä¿æ‰€æœ‰æ•°æ®åŠ è½½æˆåŠŸ
# if 'mkt_cap_final' not in locals() or mkt_cap_final.empty:
#     print("âŒ é”™è¯¯ï¼šmkt_cap_final æœªæˆåŠŸåŠ è½½æˆ–ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œåç»­æ­¥éª¤ã€‚")
# elif not bl_rebalance_dates:
#     print("âŒ é”™è¯¯ï¼šBL è°ƒä»“æ—¥ bl_rebalance_dates åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œåç»­æ­¥éª¤ã€‚")
# else:
#     # å­˜å‚¨æ¯ä¸ªè°ƒä»“æ—¥å¸‚å€¼ Series çš„å­—å…¸
#     rebalance_date_mkt_cap = {}
#
#     # 1. å°† mkt_cap_final çš„åˆ—å (æ—¥æœŸå­—ç¬¦ä¸²) è½¬æ¢ä¸º datetime å¯¹è±¡ï¼Œæ–¹ä¾¿åç»­æŸ¥æ‰¾
#     # æ³¨æ„ï¼šä¸ºäº†ä¸ä¿®æ”¹åŸæœ‰ mkt_cap_finalï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‰¯æœ¬æˆ–ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„æ—¥æœŸåˆ—è¡¨è¿›è¡ŒæŸ¥æ‰¾
#     mkt_cap_dates = mkt_cap_final.columns.tolist()
#
#     print(f"å¸‚å€¼æ•°æ®æ—¥æœŸèŒƒå›´: {mkt_cap_dates[0]} åˆ° {mkt_cap_dates[-1]} (å…± {len(mkt_cap_dates)} å¤©)")
#
#     for date_str in bl_rebalance_dates:
#         try:
#             # æ‰¾åˆ°å¸‚å€¼æ•°æ®ä¸­ï¼Œåˆ—åä¸è°ƒä»“æ—¥ç²¾ç¡®åŒ¹é…çš„åˆ—
#             if date_str in mkt_cap_final.columns:
#                 # æå–å½“æ—¥çš„è‡ªç”±æµé€šå¸‚å€¼ (ä¸€ä¸ª Seriesï¼Œç´¢å¼•æ˜¯è‚¡ç¥¨ä»£ç )
#                 daily_mkt_cap_series = mkt_cap_final[date_str]
#                 rebalance_date_mkt_cap[date_str] = daily_mkt_cap_series
#             else:
#                 # è°ƒä»“æ—¥ä¸åœ¨å¸‚å€¼æ•°æ®çš„æ—¥æœŸèŒƒå›´æˆ–æ ¼å¼ä¸åŒ¹é…
#                 # æ‰“å°è­¦å‘Šï¼Œå¹¶å°è¯•å‘å‰æ‰¾æœ€è¿‘çš„æ—¥æœŸï¼ˆå¦‚æœéœ€è¦ï¼Œä½†ç›®å‰ä»…è¦æ±‚å½“æ—¥ï¼‰
#                 print(f"âš ï¸ è°ƒä»“æ—¥ {date_str} çš„å¸‚å€¼æ•°æ®æœªæ‰¾åˆ°ï¼Œè·³è¿‡ã€‚")
#
#         except Exception as e:
#             print(f"âŒ æŸ¥æ‰¾è°ƒä»“æ—¥ {date_str} å¸‚å€¼æ—¶å‘ç”Ÿé”™è¯¯: {e}")
#             continue
#
#     if rebalance_date_mkt_cap:
#         print(f"\nâœ… æˆåŠŸæ‰¾åˆ° {len(rebalance_date_mkt_cap)} ä¸ªè°ƒä»“æ—¥çš„å¸‚å€¼æ•°æ®ã€‚")
#
#         # æ‰“å°ç¬¬ä¸€ä¸ªè°ƒä»“æ—¥çš„å¸‚å€¼æ•°æ®ä½œä¸ºéªŒè¯
#         first_date = next(iter(rebalance_date_mkt_cap))
#         first_mkt_cap = rebalance_date_mkt_cap[first_date]
#
#         print(f"--- è°ƒä»“æ—¥ {first_date} çš„è‡ªç”±æµé€šå¸‚å€¼ (å‰ 5 ä¸ª): ---")
#         # ç­›é€‰å‡ºå¸‚å€¼å¤§äº 0 çš„å‰ 5 ä¸ªè‚¡ç¥¨
#         print(first_mkt_cap[first_mkt_cap > 0].head())
#     else:
#         print("âŒ è­¦å‘Šï¼šæ²¡æœ‰è°ƒä»“æ—¥ä¸å¸‚å€¼æ•°æ®æ—¥æœŸç²¾ç¡®åŒ¹é…ã€‚è¯·æ£€æŸ¥ä¸¤ä¸ªæ—¥æœŸåˆ—è¡¨çš„æ ¼å¼å’ŒèŒƒå›´æ˜¯å¦ä¸€è‡´ã€‚")
#
# print("-" * 40)
#
# # =================================================================
# # === æ–°å¢é€»è¾‘ï¼šç¬¬äºŒæ­¥éª¤ï¼šè°ƒä»“æ—¥å’Œæˆåˆ†è‚¡çŠ¶æ€çŸ©é˜µçš„è°ƒä»“æ—¥å¯¹åº” ===
# # =================================================================
# print("\n--- ğŸš€ æ–°å¢é€»è¾‘ï¼šç¬¬äºŒæ­¥éª¤ï¼šåŒ¹é…æˆåˆ†è‚¡çŠ¶æ€æ—¥æœŸ ğŸš€ ---")
#
# if 'status_matrix_df' not in locals() or status_matrix_df.empty:
#     print("âŒ é”™è¯¯ï¼šstatus_matrix_df æœªæˆåŠŸåŠ è½½æˆ–ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œæˆåˆ†è‚¡çŠ¶æ€åŒ¹é…ã€‚")
# elif not bl_rebalance_dates:
#     print("âŒ é”™è¯¯ï¼šBL è°ƒä»“æ—¥ bl_rebalance_dates åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œåç»­æ­¥éª¤ã€‚")
# else:
#     # å­˜å‚¨æœ€ç»ˆç»“æœï¼š{è°ƒä»“æ—¥: åŒ¹é…åˆ°çš„çŠ¶æ€ Series}
#     matched_status_series = {}
#
#     # å°†çŠ¶æ€çŸ©é˜µçš„åˆ—åï¼ˆdatetimeå¯¹è±¡ï¼‰è½¬æ¢ä¸º Python çš„ datetime åˆ—è¡¨ï¼Œæ–¹ä¾¿æ’åºå’ŒæŸ¥æ‰¾
#     # ç¡®ä¿çŠ¶æ€çŸ©é˜µçš„åˆ—æ˜¯ datetime å¯¹è±¡ï¼Œæ–¹ä¾¿æ¯”è¾ƒ
#     status_dates = status_matrix_df.columns.tolist()
#
#     # è½¬æ¢ä¸º Seriesï¼Œæ–¹ä¾¿ä½¿ç”¨ idxmax() æˆ–ç±»ä¼¼çš„å‡½æ•°è¿›è¡Œé«˜æ•ˆæŸ¥æ‰¾
#     status_dates_series = pd.Series(status_dates)
#
#     print(
#         f"çŠ¶æ€çŸ©é˜µæ—¥æœŸèŒƒå›´: {min(status_dates).strftime('%Y-%m-%d')} åˆ° {max(status_dates).strftime('%Y-%m-%d')} (å…± {len(status_dates)} ä¸ªå¿«ç…§)")
#
#     for date_str in bl_rebalance_dates:
#         rebalance_date = pd.to_datetime(date_str)
#
#         # ç­›é€‰æ‰€æœ‰å°äºè°ƒä»“æ—¥çš„æˆåˆ†è‚¡çŠ¶æ€æ—¥æœŸ
#         previous_status_dates = status_dates_series[status_dates_series < rebalance_date]
#
#         if previous_status_dates.empty:
#             print(f"âš ï¸ è°ƒä»“æ—¥ {date_str} ä¹‹å‰æ²¡æœ‰å¯ç”¨çš„æˆåˆ†è‚¡çŠ¶æ€å¿«ç…§ï¼Œè·³è¿‡ã€‚")
#             continue
#
#         # æ‰¾åˆ°å°äºè°ƒä»“æ—¥ä¸”è·ç¦»è°ƒä»“æ—¥æœ€è¿‘çš„æ—¥æœŸ
#         # é€šè¿‡ idxmax() æ‰¾åˆ°æœ€å¤§å€¼ï¼ˆå³æœ€æ¥è¿‘è°ƒä»“æ—¥çš„æ—¥æœŸï¼‰
#         closest_status_date = previous_status_dates.max()
#
#         # æå–è¯¥æ—¥æœŸçš„æˆåˆ†è‚¡çŠ¶æ€ Series
#         # æ³¨æ„ï¼šstatus_matrix_df çš„åˆ—åæ˜¯ datetime å¯¹è±¡
#         status_series = status_matrix_df[closest_status_date]
#
#         # è®°å½•ç»“æœï¼Œä½¿ç”¨è°ƒä»“æ—¥ä½œä¸ºé”®
#         matched_status_series[date_str] = status_series
#
#         # å¯é€‰ï¼šæ‰“å°åŒ¹é…ä¿¡æ¯
#         print(f"è°ƒä»“æ—¥ {date_str} åŒ¹é…åˆ°çŠ¶æ€å¿«ç…§: {closest_status_date.strftime('%Y-%m-%d')}")
#
#     if matched_status_series:
#         print(f"\nâœ… æˆåŠŸå°† {len(matched_status_series)} ä¸ªè°ƒä»“æ—¥åŒ¹é…åˆ°æˆåˆ†è‚¡çŠ¶æ€å¿«ç…§ã€‚")
#
#         # æ‰“å°ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœä½œä¸ºéªŒè¯
#         first_date = next(iter(matched_status_series))
#         first_status = matched_status_series[first_date]
#
#         print(f"--- è°ƒä»“æ—¥ {first_date} åŒ¹é…åˆ°çš„çŠ¶æ€ Series (å‰ 5 ä¸ª): ---")
#         # ç­›é€‰å‡ºçŠ¶æ€ä¸º 1 çš„å‰ 5 ä¸ªè‚¡ç¥¨
#         print(first_status[first_status == 1].head())
#     else:
#         print("âŒ è­¦å‘Šï¼šæ²¡æœ‰è°ƒä»“æ—¥èƒ½å¤ŸåŒ¹é…åˆ°ä¹‹å‰çš„æˆåˆ†è‚¡çŠ¶æ€å¿«ç…§ã€‚")
#
# print("-" * 40)
#
# # === æ–°å¢é€»è¾‘ï¼šç¬¬ä¸‰æ­¥éª¤ï¼šæå–è°ƒä»“æ—¥è¢«æ ‡è®°ä¸º 1 çš„æˆåˆ†è‚¡å¸‚å€¼ (final_component_mkt_cap) ===
# # =================================================================
# # ğŸš¨ å…³é”®ï¼šåˆå§‹åŒ– final_component_mkt_capï¼Œç¡®ä¿åç»­ç¬¬å››æ­¥èƒ½è®¿é—®
# final_component_mkt_cap = {}
# print("\n--- ğŸš€ æ–°å¢é€»è¾‘ï¼šç¬¬ä¸‰æ­¥éª¤ï¼šæå–æˆåˆ†è‚¡å¸‚å€¼ ğŸš€ ---")
#
# # ç¡®ä¿ rebalance_date_mkt_cap å’Œ matched_status_series å­˜åœ¨ï¼ˆå®ƒä»¬åº”è¯¥åœ¨ç¬¬ä¸€å’Œç¬¬äºŒæ­¥éª¤ä¸­è¢«å®šä¹‰ï¼‰
#
# # å‡è®¾ rebalance_date_mkt_cap å’Œ matched_status_series å·²ç»è¢«å‰é¢çš„é€»è¾‘å—æˆåŠŸå¡«å……ã€‚
# # æˆ‘ä»¬åªéœ€è¦æ£€æŸ¥å®ƒä»¬æ˜¯å¦éç©ºã€‚
#
# if ('rebalance_date_mkt_cap' in locals() and rebalance_date_mkt_cap) and \
#         ('matched_status_series' in locals() and matched_status_series):
#
#     processed_count = 0
#     for date_str, status_series in matched_status_series.items():
#         if date_str in rebalance_date_mkt_cap:
#             daily_mkt_cap_series = rebalance_date_mkt_cap[date_str]
#
#             # 1. å¯¹é½å¸‚å€¼æ•°æ®å’ŒçŠ¶æ€æ•°æ® (join='inner' ç¡®ä¿åªä¿ç•™å…±åŒçš„è‚¡ç¥¨)
#             aligned_data = pd.concat([daily_mkt_cap_series, status_series], axis=1, join='inner')
#             aligned_data.columns = ['MKT_CAP', 'STATUS']
#
#             # 2. ç­›é€‰ STATUS == 1 (æˆåˆ†è‚¡) ä¸” MKT_CAP > 0 (æœ‰æ•ˆå¸‚å€¼)
#             component_mkt_cap = aligned_data[
#                 (aligned_data['STATUS'] == 1) & (aligned_data['MKT_CAP'] > 0)
#                 ]['MKT_CAP']
#
#             if not component_mkt_cap.empty:
#                 final_component_mkt_cap[date_str] = component_mkt_cap
#                 processed_count += 1
#
#     if final_component_mkt_cap:
#         print(f"âœ… æˆåŠŸä» {processed_count} ä¸ªè°ƒä»“æ—¥ä¸­æå–äº†æˆåˆ†è‚¡å¸‚å€¼æ•°æ®ã€‚")
#
#         # æ‰“å°ç¬¬ä¸€ä¸ªè°ƒä»“æ—¥çš„æˆåˆ†è‚¡å¸‚å€¼ä½œä¸ºéªŒè¯
#         first_date = next(iter(final_component_mkt_cap))
#         first_mkt_cap = final_component_mkt_cap[first_date]
#
#         print(f"--- è°ƒä»“æ—¥ {first_date} çš„æˆåˆ†è‚¡è‡ªç”±æµé€šå¸‚å€¼ (å‰ 5 ä¸ª): ---")
#         print(first_mkt_cap.head())
#         print(f"è¯¥æ—¥æˆåˆ†è‚¡æ€»æ•°: {len(first_mkt_cap)}")
#     else:
#         print("âŒ è­¦å‘Šï¼šæ‰€æœ‰è°ƒä»“æ—¥å¸‚å€¼ç­›é€‰åä¸ºç©ºã€‚è¯·æ£€æŸ¥æ•°æ®å¯¹é½å’Œç­›é€‰æ¡ä»¶ã€‚")
#
# else:
#     print("âŒ é”™è¯¯ï¼šå¸‚å€¼æˆ–çŠ¶æ€åŒ¹é…æ•°æ®ç¼ºå¤±ï¼Œè·³è¿‡ç¬¬ä¸‰æ­¥éª¤ã€‚")
# print("-" * 40)
#
# # -------------------- åœ¨ ç¬¬å››æ­¥éª¤ ä¹‹å‰æ’å…¥ä»¥ä¸‹è¯Šæ–­ä»£ç  --------------------
# print("\n--- è¯Šæ–­ï¼šæ£€æŸ¥æœ€ç»ˆå¸‚å€¼æ•°æ® (final_component_mkt_cap) ---")
#
# if final_component_mkt_cap:
#     first_date = next(iter(final_component_mkt_cap))
#     first_mkt_cap = final_component_mkt_cap[first_date]
#
#     print(f"æ£€æŸ¥æ—¥æœŸ: {first_date}")
#     print(f"æ•°æ®æ€»æ•°: {len(first_mkt_cap)}")
#     print(f"æ•°æ®ç±»å‹: {first_mkt_cap.dtype}")
#     print("å¸‚å€¼ç»Ÿè®¡é‡:")
#     print(first_mkt_cap.describe())
#
#     # æ‰“å°å‰20ä¸ªå€¼ï¼Œä»¥ç¡®è®¤å®ƒä»¬æ˜¯å¦éƒ½ç›¸ç­‰
#     print("\nå‰20ä¸ªå¸‚å€¼å€¼:")
#     print(first_mkt_cap.head(20))
# else:
#     print("å¸‚å€¼å­—å…¸ä¸ºç©ºï¼Œæ— æ³•è¯Šæ–­ã€‚")
#
# print("-" * 40)
# # -------------------- ç»§ç»­æ‰§è¡Œ ç¬¬å››æ­¥éª¤ --------------------
#
# # =================================================================
# # === æ–°å¢é€»è¾‘ï¼šç¬¬å››æ­¥éª¤ï¼šè®¡ç®—æˆåˆ†è‚¡æƒé‡ (åŸºäºè‡ªç”±æµé€šå¸‚å€¼) ===
# # =================================================================
# print("\n--- ğŸš€ æ–°å¢é€»è¾‘ï¼šç¬¬å››æ­¥éª¤ï¼šè®¡ç®—æˆåˆ†è‚¡æƒé‡ ğŸš€ ---")
#
# # å­˜å‚¨æœ€ç»ˆç»“æœï¼š{è°ƒä»“æ—¥: è‚¡ç¥¨æƒé‡ Series}
# final_component_weights = {}
#
# if 'final_component_mkt_cap' not in locals():
#     # å°è¯•æ¢å¤å˜é‡ï¼Œä»¥é˜²å‰ä¸€æ­¥éª¤é€»è¾‘å—å®šä¹‰åæœªåœ¨å…¨å±€ç”Ÿæ•ˆ
#     final_component_mkt_cap = {}
#
# if final_component_mkt_cap:
#     processed_count = 0
#     # éå†æ¯ä¸ªè°ƒä»“æ—¥åŠå…¶æˆåˆ†è‚¡å¸‚å€¼ Series
#     for date_str, mkt_cap_series in final_component_mkt_cap.items():
#
#         # 1. è®¡ç®—æ‰€æœ‰æˆåˆ†è‚¡çš„æ€»å¸‚å€¼ (åˆ†æ¯)
#         total_mkt_cap = mkt_cap_series.sum()
#
#         if total_mkt_cap > 0:
#             # 2. è®¡ç®—æƒé‡ï¼šä¸ªè‚¡å¸‚å€¼ / æ€»å¸‚å€¼
#             weights_series = mkt_cap_series / total_mkt_cap
#             final_component_weights[date_str] = weights_series
#             processed_count += 1
#         else:
#             print(f"âš ï¸ è°ƒä»“æ—¥ {date_str} çš„æ€»å¸‚å€¼è®¡ç®—ä¸ºé›¶ï¼Œæ— æ³•è®¡ç®—æƒé‡ï¼Œè·³è¿‡ã€‚")
#
#     if final_component_weights:
#         print(f"\nâœ… æˆåŠŸè®¡ç®—äº† {processed_count} ä¸ªè°ƒä»“æ—¥çš„æˆåˆ†è‚¡æƒé‡ã€‚")
#
#         # æ‰“å°ç¬¬ä¸€ä¸ªè°ƒä»“æ—¥çš„æˆåˆ†è‚¡æƒé‡ä½œä¸ºéªŒè¯
#         first_date = next(iter(final_component_weights))
#         first_weights = final_component_weights[first_date]
#
#         print(f"--- è°ƒä»“æ—¥ {first_date} çš„æˆåˆ†è‚¡æƒé‡ (å‰ 5 ä¸ª): ---")
#         print(first_weights.head())
#         print(f"è¯¥æ—¥æƒé‡æ€»å’Œ (åº”æ¥è¿‘ 1.0): {first_weights.sum():.6f}")
#     else:
#         print("âŒ è­¦å‘Šï¼šæ²¡æœ‰è°ƒä»“æ—¥èƒ½å¤ŸæˆåŠŸè®¡ç®—æƒé‡ã€‚")
# else:
#     print("âŒ é”™è¯¯ï¼šæˆåˆ†è‚¡å¸‚å€¼æ•°æ® final_component_mkt_cap ç¼ºå¤±ï¼Œè·³è¿‡ç¬¬å››æ­¥éª¤ã€‚")
#
# print("-" * 40)
#
# # =================================================================
# # === æ–°å¢é€»è¾‘ï¼šç¬¬äº”æ­¥éª¤ï¼šå°†æƒé‡è¾“å‡ºåˆ° Excel æ–‡ä»¶ ===
# # =================================================================
# print("\n--- ğŸš€ æ–°å¢é€»è¾‘ï¼šç¬¬äº”æ­¥éª¤ï¼šå¯¼å‡ºæƒé‡æ•°æ® ğŸš€ ---")
#
# if final_component_weights:
#     # 1. å°†å­—å…¸è½¬æ¢ä¸º DataFrame
#     # DataFrame çš„åˆ—åä¸ºæ—¥æœŸï¼Œç´¢å¼•ä¸ºè‚¡ç¥¨ä»£ç 
#     weights_df = pd.DataFrame(final_component_weights)
#
#     # 2. å¡«å…… NaN ä¸º 0 (å¯é€‰ï¼Œä½†é€šå¸¸æƒé‡æ•°æ®ä¹ æƒ¯æ²¡æœ‰å€¼å°±è®¤ä¸ºæ˜¯ 0)
#     weights_df = weights_df.fillna(0)
#
#     # 3. å®šä¹‰è¾“å‡ºæ–‡ä»¶è·¯å¾„
#     OUTPUT_FILE = "è®¡ç®—åŸºå‡†æƒé‡ç»“æœ.xlsx"
#     output_path = os.path.join(BASE_DATA_PATH, OUTPUT_FILE)
#
#     try:
#         # 4. å¯¼å‡ºåˆ° Excel
#         weights_df.to_excel(output_path, float_format='%.8f')
#         print(f"âœ… æƒé‡æ•°æ®æˆåŠŸå¯¼å‡ºåˆ°æ–‡ä»¶: {OUTPUT_FILE}")
#         print(f"   æ–‡ä»¶è·¯å¾„: {output_path}")
#         print(f"   æœ€ç»ˆæƒé‡çŸ©é˜µå½¢çŠ¶: {weights_df.shape}")
#
#     except Exception as e:
#         print(f"âŒ å¯¼å‡º Excel æ–‡ä»¶å¤±è´¥ã€‚è¯¦ç»†ä¿¡æ¯: {e}")
#
# else:
#     print("âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¡ç®—å‡ºä»»ä½•æˆåˆ†è‚¡æƒé‡ï¼Œè·³è¿‡å¯¼å‡ºæ­¥éª¤ã€‚")
#
# print("-" * 40)
#
# =================================================================
# === æ–°å¢é€»è¾‘ï¼šç¬¬å…­æ­¥éª¤ï¼šåˆå¹¶åŸºå‡†æƒé‡å’Œ BL ä¼˜åŒ–æƒé‡ (70/30) ===
# =================================================================
print("\n--- ğŸš€ æ–°å¢é€»è¾‘ï¼šç¬¬å…­æ­¥éª¤ï¼šåˆå¹¶å¹¶å¯¼å‡ºæœ€ç»ˆæƒé‡ ğŸš€ ---")

# --- é…ç½®æ–‡ä»¶è·¯å¾„ ---
BENCHMARK_WEIGHTS_FILE = "è®¡ç®—åŸºå‡†æƒé‡ç»“æœ.xlsx"
BL_HOLDINGS_FILE = "BLä¼˜åŒ–ç­–ç•¥_æŒä»“å¸‚å€¼è¯¦æƒ….xlsx"

benchmark_path = os.path.join(BASE_DATA_PATH, BENCHMARK_WEIGHTS_FILE)
bl_holdings_path = os.path.join(BASE_DATA_PATH, BL_HOLDINGS_FILE)

# --- 1. è¯»å–æ•°æ® ---
try:
    print(f"1. è¯»å–åŸºå‡†æƒé‡: {BENCHMARK_WEIGHTS_FILE}")
    # å‡è®¾åŸºå‡†æƒé‡æ–‡ä»¶ç¬¬ä¸€è¡Œæ˜¯æ—¥æœŸï¼Œç¬¬ä¸€åˆ—æ˜¯ä»£ç 
    benchmark_weights_df = pd.read_excel(benchmark_path, index_col=0)
    # ç¡®ä¿åˆ—åæ˜¯ datetime å¯¹è±¡ (æˆ–è€…è‡³å°‘æ˜¯å¯æ¯”è¾ƒçš„å­—ç¬¦ä¸²)
    benchmark_weights_df.columns = pd.to_datetime(benchmark_weights_df.columns).strftime('%Y-%m-%d')
    print(f"   âœ… åŸºå‡†æƒé‡å½¢çŠ¶: {benchmark_weights_df.shape}")

    print(f"2. è¯»å– BL ä¼˜åŒ–æƒé‡: {BL_HOLDINGS_FILE}")
    # å‡è®¾ BL æƒé‡æ–‡ä»¶ç¬¬ä¸€è¡Œæ˜¯æ—¥æœŸï¼Œç¬¬ä¸€åˆ—æ˜¯ä»£ç 
    # æ³¨æ„ï¼šBLä¼˜åŒ–ç­–ç•¥_æŒä»“å¸‚å€¼è¯¦æƒ….xlsx æ–‡ä»¶å¯èƒ½éœ€è¦æ ¹æ®å®é™…ç»“æ„è°ƒæ•´è¯»å–æ–¹å¼
    # è¿™é‡Œå‡è®¾å®ƒä¸åŸºå‡†æƒé‡ç»“æ„ç›¸åŒ (ç¬¬ä¸€åˆ—ä»£ç ï¼Œåç»­åˆ—æ—¥æœŸ)
    bl_weights_df_raw = pd.read_excel(bl_holdings_path, header=None)

    # æå– BL æƒé‡ï¼šå‡è®¾ç¬¬ä¸€è¡Œæ˜¯æ—¥æœŸï¼Œç¬¬ä¸€åˆ—æ˜¯ä»£ç ã€‚
    bl_dates = pd.to_datetime(bl_weights_df_raw.iloc[0, 1:].tolist(), errors='coerce').dropna().strftime('%Y-%m-%d')

    bl_weights_df = bl_weights_df_raw.iloc[1:].set_index(0)
    bl_weights_df.columns = bl_dates
    bl_weights_df.index.name = None

    # ä¼˜åŒ–æƒé‡é€šå¸¸ä»¥å¸‚å€¼æˆ–æŒä»“é‡å½¢å¼ç»™å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾å®ƒå­˜å‚¨çš„æ˜¯æƒé‡æˆ–éœ€è¦è®¡ç®—æƒé‡
    # å¦‚æœ BL_HOLDINGS_FILE å­˜å‚¨çš„æ˜¯å¸‚å€¼ï¼Œåˆ™éœ€è¦å…ˆè®¡ç®—æƒé‡ã€‚ä½†æ ¹æ®æ–‡ä»¶åï¼Œæˆ‘ä»¬å‡è®¾å…¶åŒ…å«äº†æƒé‡ä¿¡æ¯ã€‚
    # æˆ‘ä»¬å°†æ•°å€¼åŒ–æ‰€æœ‰æ•°æ®å¹¶å¡«å…… NaN (æœªæŒæœ‰çš„è‚¡ç¥¨æƒé‡ä¸º 0)
    bl_weights_df = bl_weights_df.apply(pd.to_numeric, errors='coerce').fillna(0)
    print(f"   âœ… BL ä¼˜åŒ–æƒé‡å½¢çŠ¶: {bl_weights_df.shape}")

except Exception as e:
    print(f"âŒ é”™è¯¯ï¼šåŠ è½½æƒé‡æ–‡ä»¶å¤±è´¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œå†…éƒ¨ç»“æ„ã€‚è¯¦ç»†ä¿¡æ¯: {e}")
    print("-" * 40)
    # ç»ˆæ­¢åç»­æ“ä½œ
    raise

# --- 2. å¯¹é½ã€åˆå¹¶è®¡ç®—æƒé‡ ---

# ç»Ÿä¸€æ‰€æœ‰è‚¡ç¥¨ä»£ç å’Œè°ƒä»“æ—¥æœŸï¼Œç¡®ä¿ä¸¤ä¸ª DataFrame èƒ½å¤Ÿå¯¹é½
all_index = benchmark_weights_df.index.union(bl_weights_df.index)
all_columns = benchmark_weights_df.columns.union(bl_weights_df.columns)

# é‡æ–°ç´¢å¼•å¹¶å¡«å…… 0
W_b = benchmark_weights_df.reindex(index=all_index, columns=all_columns).fillna(0)  # åŸºå‡†æƒé‡ (W_b)
W_bl = bl_weights_df.reindex(index=all_index, columns=all_columns).fillna(0)  # BL ä¼˜åŒ–æƒé‡ (W_bl)

# å®šä¹‰åˆ†é…æ¯”ä¾‹
ALPHA = 0.70  # åŸºå‡†æƒé‡å æ¯”
BETA = 0.30  # BL ä¼˜åŒ–æƒé‡å æ¯”

print("\n3. å¼€å§‹è®¡ç®—åˆå¹¶æƒé‡...")

# è®¡ç®—æœ€ç»ˆæƒé‡ï¼šW_final = W_b * ALPHA + W_bl * BETA
final_combined_weights_df = (W_b * ALPHA) + (W_bl * BETA)

print("   âœ… åˆå¹¶æƒé‡è®¡ç®—å®Œæˆã€‚")
print("--- æœ€ç»ˆåˆå¹¶æƒé‡ (å‰ 5 è¡Œ, å‰ 3 åˆ—): ---")
print(final_combined_weights_df.head(5).iloc[:, :3])

# --- 3. å¯¼å‡ºç»“æœ ---

OUTPUT_COMBINED_FILE = "æœ€ç»ˆåˆå¹¶æƒé‡_70_30.xlsx"
output_combined_path = os.path.join(BASE_DATA_PATH, OUTPUT_COMBINED_FILE)

try:
    # å¯¼å‡ºåˆ° Excel
    final_combined_weights_df.to_excel(output_combined_path, float_format='%.8f')
    print(f"\n4. æƒé‡æ•°æ®æˆåŠŸå¯¼å‡ºåˆ°æ–‡ä»¶: {OUTPUT_COMBINED_FILE}")
    print(f"   æ–‡ä»¶è·¯å¾„: {output_combined_path}")
    print(f"   æœ€ç»ˆåˆå¹¶æƒé‡çŸ©é˜µå½¢çŠ¶: {final_combined_weights_df.shape}")

except Exception as e:
    print(f"âŒ é”™è¯¯ï¼šå¯¼å‡ºæœ€ç»ˆåˆå¹¶æƒé‡ Excel æ–‡ä»¶å¤±è´¥ã€‚è¯¦ç»†ä¿¡æ¯: {e}")

print("-" * 40)

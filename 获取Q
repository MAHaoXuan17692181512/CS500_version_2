import pandas as pd
import os
import re
from datetime import datetime

# ----------------- ã€è¯·ä¿®æ”¹ä»¥ä¸‹è·¯å¾„ã€‘ -----------------
Q_folder_path = r"C:\Users\cufet\Desktop\Q"
pai_folder_path = r"C:\Users\cufet\Desktop\å…ˆéªŒå‡å€¼pai"
# æœ€ç»ˆè¾“å‡ºexcelæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
output_file_path = r'C:\Users\cufet\Desktop\filtered_updated_returns.xlsx'


# ------------------------------------------------------

# è¾…åŠ©å‡½æ•°ï¼šä»æ–‡ä»¶å/Sheetåä¸­æå–æˆªæ­¢æ—¥æœŸï¼ˆ'to_'åé¢çš„æ—¥æœŸï¼‰
def extract_end_date(name):
    """ä» YYYY-MM-DD_to_YYYY-MM-DD æ ¼å¼çš„å­—ç¬¦ä¸²ä¸­æå–ç¬¬äºŒä¸ªæ—¥æœŸã€‚"""
    match = re.search(r'to[_\s](\d{4}-\d{2}-\d{2})', str(name), re.IGNORECASE)
    if match: return match.group(1)
    return None


# --- 1. è¯»å–å¹¶åˆå¹¶å…ˆéªŒå‡å€¼ï¼ˆæ„å»º df_pai_initial å’Œ ç›®æ ‡æ—¥æœŸåˆ—è¡¨ï¼‰ ---

list_df_pai = []
# *** æ–°å¢ï¼šå­˜å‚¨æ‰€æœ‰ pai sheet ä¸­æå–åˆ°çš„æ—¥æœŸï¼Œä½œä¸ºæœ€ç»ˆç­›é€‰çš„ä¾æ® ***
target_output_dates = set()

try:
    for filename in os.listdir(pai_folder_path):
        if filename.endswith(('.xls', '.xlsx')):
            full_path = os.path.join(pai_folder_path, filename)
            xls = pd.ExcelFile(full_path)
            for sheet_name in xls.sheet_names:
                date_str = extract_end_date(sheet_name)

                if date_str:
                    # æ”¶é›†ç›®æ ‡æ—¥æœŸï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰
                    target_output_dates.add(date_str)
                    # å°†æ—¥æœŸè½¬æ¢ä¸º datetime å¯¹è±¡ç”¨äºæ„å»º df_pai_initial
                    date_key = datetime.strptime(date_str, '%Y-%m-%d')
                else:
                    continue

                df_pai_temp = pd.read_excel(xls, sheet_name=sheet_name)
                if df_pai_temp.shape[1] < 2: continue

                df_pai_temp.columns = ['è‚¡ç¥¨ä»£ç ', 'é¢„æœŸæ”¶ç›Š_åˆå§‹'] + list(df_pai_temp.columns[2:])
                df_temp = df_pai_temp[['è‚¡ç¥¨ä»£ç ', 'é¢„æœŸæ”¶ç›Š_åˆå§‹']].copy()
                df_temp['Date'] = date_key
                df_temp = df_temp.dropna(subset=['è‚¡ç¥¨ä»£ç ', 'é¢„æœŸæ”¶ç›Š_åˆå§‹'])
                list_df_pai.append(df_temp)

    if not list_df_pai:
        print(f"é”™è¯¯ï¼šåœ¨æ–‡ä»¶å¤¹ {pai_folder_path} ä¸­æœªæ‰¾åˆ°ä»»ä½•åŒ…å«æœ‰æ•ˆæ—¥æœŸçš„ Excel æ•°æ®ã€‚")
        exit()

    df_pai_all_history = pd.concat(list_df_pai, ignore_index=True)
    df_pai_all_history['é¢„æœŸæ”¶ç›Š_åˆå§‹'] = pd.to_numeric(df_pai_all_history['é¢„æœŸæ”¶ç›Š_åˆå§‹'], errors='coerce')

    # æ‰¾åˆ°æ¯ä¸ªè‚¡ç¥¨ä»£ç çš„æœ€æ–°æ•°æ®ç‚¹ (æŒ‰ 'Date' æ’åºå¹¶å»é‡ï¼Œä¿ç•™æœ€æ–° 'last')
    df_pai_initial = (
        df_pai_all_history.sort_values('Date')
        .drop_duplicates(subset=['è‚¡ç¥¨ä»£ç '], keep='last')
        .set_index('è‚¡ç¥¨ä»£ç ')
        [['é¢„æœŸæ”¶ç›Š_åˆå§‹']]
    )

except Exception as e:
    print(f"è¯»å–å…ˆéªŒå‡å€¼æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {e}")
    exit()

all_stocks = df_pai_initial.index.tolist()
print("-" * 50)
print(f"æˆåŠŸæ„å»ºåˆå§‹å…ˆéªŒå‡å€¼æ•°æ® (ä½œä¸ºæ›¿æ¢åŸºå‡†)ï¼Œå…± {len(df_pai_initial)} ä¸ªè‚¡ç¥¨ã€‚")
print(f"ç›®æ ‡è¾“å‡ºæ—¥æœŸåˆ—è¡¨ (æ¥è‡ª pai folder): {sorted(list(target_output_dates))}")
print("-" * 50)

# ç”¨äºå­˜å‚¨æ¯æ—¥æ›´æ–°åçš„ DataFrame (key: æ—¥æœŸå­—ç¬¦ä¸², value: æ›´æ–°åçš„ df)
daily_updated_dataframes = {}

# --- 2. éå†Q folderï¼Œæ‰§è¡Œæ›¿æ¢é€»è¾‘ (ç”Ÿæˆæ‰€æœ‰ Q æ—¥æœŸçš„æ›´æ–°ç»“æœ) ---

for filename in os.listdir(Q_folder_path):
    if filename.endswith(('.xls', '.xlsx')):
        full_path = os.path.join(Q_folder_path, filename)

        print(f"æ­£åœ¨å¤„ç† Q æ–‡ä»¶: {filename}...")

        try:
            df_Q_raw = pd.read_excel(full_path, sheet_name=0)
            date_col = df_Q_raw.columns[0]

            # å®½æ ¼å¼è½¬é•¿æ ¼å¼
            df_Q_long = df_Q_raw.melt(
                id_vars=[date_col],
                var_name='è‚¡ç¥¨ä»£ç ',
                value_name='Qæ”¶ç›Š'
            )

            df_Q_long['Date'] = pd.to_datetime(df_Q_long[date_col])
            df_Q_long['è‚¡ç¥¨ä»£ç '] = df_Q_long['è‚¡ç¥¨ä»£ç '].astype(str).str.strip()
            df_Q_long = df_Q_long.drop(columns=[date_col]).dropna(subset=['Qæ”¶ç›Š'])

            # éå† Q æ•°æ®ä¸­çš„æ¯ä¸ªäº¤æ˜“æ—¥å¹¶æ‰§è¡Œæ›¿æ¢
            unique_dates_in_Q = sorted(df_Q_long['Date'].unique())

            for date_in_Q in unique_dates_in_Q:
                date_str = date_in_Q.strftime('%Y-%m-%d')

                df_Q_daily = df_Q_long[df_Q_long['Date'] == date_in_Q]
                series_Q_daily = df_Q_daily.set_index('è‚¡ç¥¨ä»£ç ')['Qæ”¶ç›Š']

                # --- æ‰§è¡Œæ›¿æ¢é€»è¾‘ (Outer Merge) ---
                df_updated = series_Q_daily.to_frame().rename(columns={'Qæ”¶ç›Š': 'é¢„æœŸæ”¶ç›Š_æ›´æ–°'})

                df_updated = df_updated.merge(
                    df_pai_initial,
                    left_index=True,
                    right_index=True,
                    how='outer'
                )

                # å¡«å……é€»è¾‘ï¼šè‹¥ Q æ”¶ç›Šä¸º NaNï¼Œåˆ™ç”¨åˆå§‹ pai æ”¶ç›Šå¡«å……
                df_updated['é¢„æœŸæ”¶ç›Š_æ›´æ–°'] = df_updated['é¢„æœŸæ”¶ç›Š_æ›´æ–°'].fillna(df_updated['é¢„æœŸæ”¶ç›Š_åˆå§‹'])

                # å­˜å‚¨ç»“æœ
                daily_updated_dataframes[date_str] = df_updated[['é¢„æœŸæ”¶ç›Š_æ›´æ–°']].rename(
                    columns={'é¢„æœŸæ”¶ç›Š_æ›´æ–°': 'é¢„æœŸæ”¶ç›Š'})

                # print(f"    - å®Œæˆæ—¥æœŸ {date_str} çš„æ›´æ–°å’Œå­˜å‚¨ã€‚") # å‡å°‘è¾“å‡ºï¼ŒåŠ å¿«é€Ÿåº¦

        except Exception as e:
            print(f"å¤„ç†æ–‡ä»¶ {filename} æ—¶å‘ç”Ÿé”™è¯¯: {e}")

        # print("-" * 50) # å‡å°‘è¾“å‡º

# --- 3. ç»„ç»‡ç»“æœå¹¶è¾“å‡º Excel (ç­›é€‰å¹¶è¾“å‡ºç›®æ ‡æ—¥æœŸ) ---

if not daily_updated_dataframes:
    print("æœªæˆåŠŸå¤„ç†ä»»ä½• Q æ–‡ä»¶ä¸­çš„æ—¥æœŸæ•°æ®ï¼Œç¨‹åºé€€å‡ºã€‚")
else:
    # ç­›é€‰å‡ºéœ€è¦è¾“å‡ºçš„ç›®æ ‡æ—¥æœŸ
    output_dataframes = {}
    for date_str in sorted(list(target_output_dates)):
        if date_str in daily_updated_dataframes:
            output_dataframes[date_str] = daily_updated_dataframes[date_str]
        else:
            print(f"è­¦å‘Šï¼šç›®æ ‡æ—¥æœŸ {date_str} æ— æ³•åœ¨ Q æ•°æ®ä¸­æ‰¾åˆ°å¯¹åº”çš„æ›´æ–°ç»“æœï¼Œè·³è¿‡æ­¤æ—¥æœŸã€‚")

    if not output_dataframes:
        print("æ‰€æœ‰ç›®æ ‡æ—¥æœŸå‡æœªåœ¨ Q æ•°æ®ä¸­æ‰¾åˆ°å¯¹åº”çš„æ›´æ–°ç»“æœï¼Œæœªç”Ÿæˆæ–‡ä»¶ã€‚")
        exit()

    print("--- æ­£åœ¨ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶ ---")

    with pd.ExcelWriter(output_file_path, engine='xlsxwriter', datetime_format='yyyy-mm-dd') as writer:
        for date_str in sorted(output_dataframes.keys()):
            df_out = output_dataframes[date_str]

            # ä½¿ç”¨ reindex ä¿è¯æ¯ä¸ª Sheet çš„è¡Œé¡ºåºä¸€è‡´ (å¯é€‰ï¼Œä½†æ¨è)
            df_out = df_out.reindex(sorted(df_out.index.tolist()))

            df_out.to_excel(writer, sheet_name=date_str, float_format='%.8f')

    print("=" * 50)
    print(f"ğŸ‰ æˆåŠŸç”Ÿæˆæœ€ç»ˆé¢„æœŸæ”¶ç›Šæ–‡ä»¶ (å·²æŒ‰ pai æ—¥æœŸç­›é€‰): {output_file_path}")
    print(f"æ€»å…±ç”Ÿæˆäº† {len(output_dataframes)} ä¸ª Sheetã€‚")
